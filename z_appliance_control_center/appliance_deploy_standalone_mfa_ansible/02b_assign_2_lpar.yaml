# *+------------------------------------------------------------------------+
# *| Â© Copyright IBM Corp. 2025                                             |
# *| [10.17.2025]                                                           |
# *|   - Tested with ACC 1.2.6                                              |
# *|   - Initial release                                                    |
# *| [12.12.2025]                                                           |
# *|   - Tested with ACC 1.2.10                                             |
# *|   - Added checking of environment variables                            |
# *+------------------------------------------------------------------------+

- name: ACC playbook, run by ACC-admin, for assigning two resource.
  hosts: localhost
  gather_facts: true
  vars_files:
    - admin_vars.yaml

  pre_tasks:
    - name: Reminder - Export ACC admin credentials
      ansible.builtin.pause:
        prompt: |
          Before running this playbook, please export ACC admin credentials:

          export ACC_ADMIN_USER=<admin_username>
          export ACC_ADMIN_PASSWORD=<admin_new_password>

          Press Ctrl+C now to cancel if you haven't done this.
          The playbook will continue shortly.
        seconds: 5

    - name: Check required environment variables
      vars:
        required_env_vars:
          - ACC_ADMIN_USER
          - ACC_ADMIN_PASSWORD

      ansible.builtin.fail:
        msg: "Missing required environment variable: {{ item }}"
      when: lookup('env', item) == ""
      loop: "{{ required_env_vars }}"

  tasks:
    - name: Confirmation required before proceeding
      ansible.builtin.pause:
        prompt: |
          This playbook will create **resource package with TWO LPAR **.
          Use 02a_assign_1_lpar.yaml playbook to create resource package with 1 lpars (Don't Run Both).
          If you want to proceed, press **Ctrl+C** and then **C**.
          If you want to cancel, press **Ctrl+C** and then **A**.
          If no action is taken, it will auto-continue in 20 seconds.
        seconds: 20

    - name: Wait for user to generate OTP
      ansible.builtin.pause:
        prompt: "Enter OTP generated from the above mfa_secret:"
      register: mfa_otp_input

    - name: 00 - Get authentication token from the ACC as admin
      ansible.builtin.uri:
        url: "{{ acc_ip }}/user/token"
        body:
          username: "{{ cc_admin_user }}"
          password: "{{ cc_admin_password }}"
          otp: "{{ mfa_otp_input.user_input }}"
        body_format: json
        method: POST
        return_content: true
        validate_certs: false
      register: auth_response

    - name: Printing the response of authentication
      ansible.builtin.debug:
        msg:
          - "{{ auth_response.json.access_token }}"

    - name: Extract the admin token
      ansible.builtin.set_fact:
        access_token: "{{ auth_response.json.access_token }}"

    - name: 01 - Validate WWPN and LUN values
      vars:
        hex_pattern: "^[A-Fa-f0-9]{16}$"
        wwpn_vars:
          - "{{ wwpn1 | default('') }}"
          - "{{ wwpn2 | default('') }}"
        lun_vars:
          - "{{ lun1 | default('') }}"
          - "{{ lun2 | default('') }}"
      block:
        - name: Validate WWPN formats
          vars:
            msg_invalid_wwpn: "Invalid WWPN '{{ item }}': must be a 16-digit hexadecimal string without '0x' prefix."
          ansible.legacy.fail:
            msg: "{{ msg_invalid_wwpn }}"
          when:
            - item | length > 0
            - item is not match(hex_pattern)
          loop: "{{ wwpn_vars }}"
        - name: Validate LUN formats
          vars:
            msg_invalid_lun: "Invalid LUN '{{ item }}': must be a 16-digit hexadecimal string without '0x' prefix."
          ansible.legacy.fail:
            msg: "{{ msg_invalid_lun }}"
          when:
            - item | length > 0
            - item is not match(hex_pattern)
          loop: "{{ lun_vars }}"

    - name: 02 - As ACC-admin, assign two LPARs to the owner
      ansible.builtin.uri:
        url: "{{ acc_ip }}/resource/pkgs"
        timeout: 300
        method: POST
        body:
          owner: "{{ cc_owner_user }}"
          name: "{{ package_name }}"
          ifls: "{{ package_ifls }}"
          gps: "{{ package_gps }}"
          memory: "{{ package_memory_mb }}"
          lpars:
            - name: "{{ lpar_name1 }}"
              interfaces:
                - name: "{{ interface1_name }}"
                  fid: "{{ fid1 }}"
                  # chpid: "{{ chpid1 }}"
                  # port: "{{ zport1 }}"
                  # vlan_id: "{{ vlan_id1 }}" # If your infra doesn't support this, comment it out
                  prefix: "{{ prefix1 }}"
                  ip: "{{ app_ip1 }}"
                  gw: "{{ gw_ip1 }}"
              boot-info:
                disk-id: "{{ disk_id1 }}"
                is-fcp: "{{ is_fcp1 }}"
                # wwpn: "{{ wwpn1 }}"
                # lun: "{{ lun1 }}"
            - name: "{{ lpar_name2 }}"
              interfaces:
                - name: "{{ interface2_name }}"
                  fid: "{{ fid2 }}"
                  # chpid: "{{ chpid2 }}"
                  # port: "{{ zport2 }}"
                  # vlan_id: "{{ vlan_id2 }}" # If your infra doesn't support this, comment it out
                  prefix: "{{ prefix2 }}"
                  ip: "{{ app_ip2 }}"
                  gw: "{{ gw_ip2 }}"
              boot-info:
                disk-id: "{{ disk_id2 }}"
                is-fcp: "{{ is_fcp2 }}"
                # wwpn: "{{ wwpn2 }}"
                # lun: "{{ lun2 }}"
          cpc: "{{ z_machine_name }}"
          x86: "dummy" # This will be deprecated
        body_format: json
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: application/json
        validate_certs: false
        status_code: 200
      register: response

    - name: Printing the response
      tags: owner, install
      ansible.builtin.debug:
        msg: "{{ response.json }}"
