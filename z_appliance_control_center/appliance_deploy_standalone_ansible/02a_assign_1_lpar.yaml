#*+-------------------------------------------------------------------+
#*| IBM Confidential                                                  |
#*|                                                                   |
#*| Licensed Materials - Property of IBM                              |
#*|                                                                   |
#*|                                                                   |
#*| Â© Copyright IBM Corp. 2025 All Rights Reserved                    |
#*|                                                                   |
#*| The source code for this program is not published or otherwise    |
#*| divested of its trade secrets, irrespective of what has been      |
#*| deposited with the U.S. Copyright Office.                         |
#*+-------------------------------------------------------------------+

- name: ACC Standalone playbook, run by ACC-admin, for assigning one resource.
  hosts: localhost
  gather_facts : true
  vars_files:
    - admin_vars.yaml
  tasks:
    - name: Confirmation required before proceeding
      ansible.builtin.pause:
        prompt: |
          This playbook will create a **resource package with ONE LPAR only**.
          Use 02b_assign_2_lpar.yaml playbook to create resource package with 2 lpars (Don't Run Both).
          If you want to proceed, press **Ctrl+C** and then **C**.
          If you want to cancel, press **Ctrl+C** and then **A**.
          If no action is taken, it will auto-continue in 20 seconds.
        seconds: 20

    - name: 09 - Get authentication token from the ACC as admin
      uri:
        url: "{{ acc_ip }}/user/token"
        body:
          username: "{{ cc_admin_user }}"
          password: "{{ cc_admin_password }}"
        body_format: json
        method: POST
        return_content: true
        validate_certs: false
      register: auth_response

    - name: Printing the response of authentication
      debug:
        msg: 
          - "{{ auth_response.json.access_token }}"

    - name: Extract the admin token
      set_fact:
        access_token: "{{ auth_response.json.access_token }}"

    - name: 10 - As ACC-admin, assign single resources to the owner
      uri:
        url: "{{ acc_ip }}/resource/pkgs"
        timeout: 300
        method: POST
        body:
          owner: "{{ cc_owner_user }}"
          name: "{{ package_name }}"
          ifls: "{{ package_ifls }}"
          gps: "{{ package_gps }}"
          memory: "{{ package_memory_mb }}"
          lpars:
            - name: "{{ z_machine_lpar }}"
              interfaces:
                - name: "{{ interface_name1 }}"
                  fid: "{{ fid1 }}"
                  # chpid: "{{ chpid1 }}"
                  # port: "{{ zport1 }}"
                  # vlan_id: "{{ vlan_id1 }}" # If your infra doesn't support this, comment it out
                  prefix: "{{ prefix1 }}"
                  ip: "{{ app_ip1 }}"
                  gw: "{{ gw_ip1 }}"
              boot-info:
                disk-id: "{{ disk_id1 }}"
                is-fcp: "{{ is_fcp1 }}"
                # wwpn: "{{ wwpn1 }}"
                # lun: "{{ lun1 }}"
          cpc: "{{ z_machine_name }}"
          x86: "dummy"          # If your infra support this, please add the correct x86 machine name
        body_format: json
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: application/json
        validate_certs: false
        status_code: 200
      register: response

    - name: Printing the response
      tags: owner, install
      debug:
        msg: "{{ response.json }}"