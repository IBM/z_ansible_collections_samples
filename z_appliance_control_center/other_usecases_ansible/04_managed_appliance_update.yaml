# *+------------------------------------------------------------------------+
# *| ¬© Copyright IBM Corp. 2025                                             |
# *| [10.17.2025]                                                           |
# *|   - Tested with ACC 1.2.6                                              |
# *|   - Initial release                                                    |
# *| [12.12.2025]                                                           |
# *|   - Tested with ACC 1.2.10                                             |
# *|   - Added checking of environment variables                            |
# *+------------------------------------------------------------------------+

- name: ACC playbook, run by appliance-owner, for appliance upgrade
  hosts: localhost
  gather_facts: true
  vars_files:
    - owner_vars.yaml

  pre_tasks:
    - name: Reminder - Export appliance-owner credentials
      ansible.builtin.pause:
        prompt: |
          Before running this playbook, please export appliance-owner credentials:

          export ACC_OWNER_PASSWORD=<owner_password>
          export APP_USERNAME=<appliance_username>
          export APP_PASSWORD=<appliance_password>

          Press Ctrl+C now to cancel if you haven't done this.
          The playbook will continue shortly.
        seconds: 5

    - name: Check required environment variables
      vars:
        required_env_vars:
          - ACC_OWNER_PASSWORD
          - APP_USERNAME
          - APP_PASSWORD

      ansible.builtin.fail:
        msg: "Missing required environment variable: {{ item }}"
      when: lookup('env', item) == ""
      loop: "{{ required_env_vars }}"

  tasks:
    - name: 00 - Check MFA is enabled or not
      ansible.legacy.pause:
        prompt: "Do you have MFA enabled? (yes/no):"
      register: mfa_enabled_input

    - name: 01 - Set MFA enabled
      ansible.legacy.set_fact:
        mfa_enabled: "{{ mfa_enabled_input.user_input | lower == 'yes' }}"

    - name: 02 - Prompt for OTP if MFA is enabled
      when: mfa_enabled
      ansible.legacy.pause:
        prompt: "Enter MFA OTP generated for owner:"
      register: mfa_otp_input

    - name: 03 - Get authentication token from the ACC as appliance-owner
      tags: owner, install
      ansible.builtin.uri:
        url: "{{ acc_ip }}/user/token"
        method: POST
        body:
          username: "{{ cc_owner_user }}"
          password: "{{ cc_owner_password }}"
          otp: "{{ (mfa_otp_input.user_input if mfa_enabled else omit) }}"
        body_format: json
        return_content: true
        validate_certs: false
      register: auth_response

    - name: Printing the response
      tags: owner
      ansible.builtin.debug:
        msg:
          - "{{ auth_response.json.access_token }}"

    - name: Extract the token
      tags: owner, install
      ansible.builtin.set_fact:
        access_token: "{{ auth_response.json.access_token }}"

    - name: 04 - Upload fix image/update bundle to the ACC as owner
      tags: owner
      # The uri module cannot upload binary files.
      # One can use `src`, but both `src` and `body` can't be used together.
      ansible.builtin.shell: 'curl -k -X "POST" \
        "{{ acc_ip }}/images" \
        -H "Authorization: Bearer {{ access_token }}" \
        -H "Content-Type: multipart/form-data" \
        -F "data=@{{ update_bundle_path }}" \
        -F "image_type={{ image_fix_type }}" \
        -F "min_ifls={{ min_ifls }}" -F "min_memory={{ min_memory }}"'
      register: response
      changed_when: false
      failed_when: >
        response.rc != 0 or
        (response.stdout is defined and 'exception' in response.stdout | lower)
      # noqa command-instead-of-module command-instead-of-shell

    - name: 05 - Get update bundle information
      tags: owner, install
      ansible.builtin.uri:
        url: "{{ acc_ip }}/images"
        method: GET
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: application/json
        validate_certs: false
      register: response
      failed_when: response.json.images | length == 0

    - name: Printing the response of get update bundle
      tags: owner, install
      ansible.builtin.debug:
        msg: "{{ response.json }}"

    - name: Extract the update bundle ID from the DB
      tags: owner, install
      ansible.builtin.set_fact:
        image_id: "{{ response.json.images[-1].id }}"

    - name: Printing the update bundle ID
      tags: owner, install
      ansible.builtin.debug:
        msg: "image id: {{ image_id }}"

    - name: 06 - Get list of running appliance
      ansible.builtin.uri:
        url: "{{ acc_ip }}/resource/quotas"
        method: GET
        headers:
          Accept: "application/json"
          Authorization: "Bearer {{ access_token }}"
        validate_certs: false
      register: quotas_response

    - name: Print quotas response
      ansible.builtin.debug:
        var: quotas_response.json

    - name: Extract app IDs from quotas
      ansible.builtin.set_fact:
        app_ids: >-
          {{
            quotas_response.json
            | selectattr('id', 'defined')
            | map(attribute='id')
            | list
          }}
    - name: Print extracted app IDs
      ansible.builtin.debug:
        msg: "App IDs to unlock: {{ app_ids | join(', ') }}"

    - name: 07 - Unlock quota using App id (comment this if already done)
      tags: owner
      loop: "{{ app_ids }}"
      loop_control:
        loop_var: app_id
      ansible.builtin.uri:
        url: "{{ acc_ip }}/unlock_quota"
        method: POST
        body:
          {
            "ssc_username": "{{ app_username }}",
            "ssc_password": "{{ app_password }}",
            "app_id": "{{ app_id }}",
          }
        body_format: json
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: application/json
        status_code: 200
        timeout: 200
        validate_certs: false
      register: unlock_responses

    - name: 08 - As owner, concurrent update the image using image_id {{ image_id }}
      tags: owner, install
      ansible.builtin.uri:
        url: "{{ acc_ip }}/cluster/upgrade"
        method: POST
        body: |
          {
            "{{ package_name }}": {
              "lpars": ["{{ lpar_name }}"],
              "image_id": {{ image_id | int }}
            }
          }
        body_format: json
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: application/json
        validate_certs: false
        status_code: 200
        dest: "{{ upgrade_fix_data }}"

    - name: Wait for 15 seconds
      ansible.builtin.pause:
        seconds: 15

    - name: Inform user about downloaded upgrade info and next steps
      ansible.builtin.debug:
        msg: "{{ playbook_info.split('\n') }}"
      vars:
        playbook_info: |
          ‚úî The concurrent update ZIP file has been successfully downloaded.

          üìÅ Location:
          {{ upgrade_fix_data }}

          üîì Please unzip the file and note the "task_id" from upgrade_info.json inside it.

          üì° To check the current status of the in-progress task, use:
          {{ acc_ip }}/tasks/<task_id>/status
