# *+------------------------------------------------------------------------+
# *| Â© Copyright IBM Corp. 2025                                             |
# *| [10.17.2025]                                                           |
# *|   - Tested with ACC 1.2.6                                              |
# *|   - Initial release                                                    |
# *| [12.12.2025]                                                           |
# *|   - Tested with ACC 1.2.10                                             |
# *|   - Renamed 12_unlock_appliances.yaml to 10_unlock_appliances.yaml     |
# *|   - Added checking of environment variables                            |
# *+------------------------------------------------------------------------+

- name: ACC Playbook, run by appliance-owner, for appliance-owner actions
  hosts: localhost
  gather_facts: true
  vars_files:
    - owner_vars.yaml

  pre_tasks:
    - name: Reminder - Export appliance-owner credentials
      ansible.builtin.pause:
        prompt: |
          Before running this playbook, please export appliance-owner credentials:

          export ACC_OWNER_PASSWORD=<owner_password>

          Press Ctrl+C now to cancel if you haven't done this.
          The playbook will continue shortly.
        seconds: 5

    - name: Check required environment variables
      vars:
        required_env_vars:
          - ACC_OWNER_PASSWORD

      ansible.builtin.fail:
        msg: "Missing required environment variable: {{ item }}"
      when: lookup('env', item) == ""
      loop: "{{ required_env_vars }}"

  tasks:
    - name: 00 - Check MFA is enabled or not
      ansible.builtin.pause:
        prompt: "Do you have MFA enabled? (yes/no):"
      register: mfa_enabled_input

    - name: 01 - Set MFA enabled
      ansible.legacy.set_fact:
        mfa_enabled: "{{ mfa_enabled_input.user_input | lower == 'yes' }}"

    - name: 02 - Prompt for OTP if MFA is enabled
      when: mfa_enabled
      ansible.builtin.pause:
        prompt: "Enter MFA OTP generated for owner:"
      register: mfa_otp_input

    - name: 03 - Get authentication token from the ACC as appliance-owner
      tags: owner, install
      ansible.builtin.uri:
        url: "{{ acc_ip }}/user/token"
        method: POST
        body:
          username: "{{ cc_owner_user }}"
          password: "{{ cc_owner_password }}"
          otp: "{{ (mfa_otp_input.user_input if mfa_enabled else omit) }}"
        body_format: json
        return_content: true
        validate_certs: false
      register: auth_response

    - name: Extract the token
      tags: owner, install
      ansible.builtin.set_fact:
        access_token: "{{ auth_response.json.access_token }}"

    - name: 04 - Get list of running appliance
      ansible.builtin.uri:
        url: "{{ acc_ip }}/resource/quotas"
        method: GET
        headers:
          Accept: "application/json"
          Authorization: "Bearer {{ access_token }}"
        validate_certs: false
      register: quotas_response

    - name: Fail if no appliances found
      ansible.builtin.fail:
        msg: "No appliances found in resource quotas for this owner."
      when: quotas_response.json | length == 0

    - name: Print available appliances summary
      ansible.builtin.debug:
        msg: >
          {% for app in quotas_response.json %}
            ID: {{ app.id }},
            Name: {{ app.name }},
            IP: {{ app.interfaces[0].ip | default('N/A') }},
            Status: {{ 'Locked' if app.is_locked else 'Unlocked' }}
          {% endfor %}

    - name: 05 - Unlock appliances one by one
      ansible.builtin.include_tasks: 11_unlock_each_appliance.yaml
      loop: "{{ quotas_response.json }}"
      loop_control:
        loop_var: appliance
