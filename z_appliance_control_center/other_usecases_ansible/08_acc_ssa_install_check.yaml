#*+-------------------------------------------------------------------+
#*| IBM Confidential                                                  |
#*|                                                                   |
#*| Licensed Materials - Property of IBM                              |
#*|                                                                   |
#*|                                                                   |
#*| Â© Copyright IBM Corp. 2025 All Rights Reserved                    |
#*|                                                                   |
#*| The source code for this program is not published or otherwise    |
#*| divested of its trade secrets, irrespective of what has been      |
#*| deposited with the U.S. Copyright Office.                         |
#*+-------------------------------------------------------------------+

- name: ACC playbook, run as ACC-admin, to get sanity check of ACC and SSAs install
  hosts: localhost
  gather_facts: true
  vars_files:
    - acc_ssa_install_check_vars.yaml
  vars:
    acc_base_url: "https://{{ acc_url }}:{{ acc_port }}/api"
    ssa1_base_url: "https://{{ ssa1_url }}/api/com.ibm.zaci.system"
    ssa2_base_url: "https://{{ ssa2_url }}/api/com.ibm.zaci.system"

  tasks:
    - name: Check if ACC appliance is operational
      uri:
        url: "https://{{ acc_url }}/api/com.ibm.zaci.system/appliance/is-operational"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
        validate_certs: no
        status_code: 204
      register: appliance_status

    - name: Fail if ACC appliance is not operational
      fail:
        msg: "ACC is not operational"
      when: appliance_status.status != 204

    - name: Get authentication token from the ACC as admin
      uri:
        url: "{{ acc_base_url }}/user/token"
        body:
          username: "{{ acc_admin_user }}"
          password: "{{ acc_admin_password }}"
        body_format: json
        method: POST
        return_content: true
        validate_certs: false
      register: auth_response

    - name: Fail if ACC did not response properly
      fail:
        msg: "ACC authentication failed"
      when: auth_response.status != 200

    - name: Extract the ACC-admin token
      set_fact:
        acc_admin_token: "{{ auth_response.json.access_token }}"

    - name: Get status of HMC connectivity from ACC
      uri:
        url: "{{ acc_base_url }}/cpcs/hmc-connection"
        timeout: 200
        method: GET
        headers:
          Authorization: "Bearer {{ acc_admin_token }}"
        validate_certs: false
        status_code: 200
      register: response

    - name: Printing the response of HMC connectivity
      debug:
        msg: "{{ response.json }}"

    - name: Check if SSA-1 appliance is operational
      uri:
        url: "{{ ssa1_base_url }}/appliance/is-operational"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
        validate_certs: no
        status_code: 204
      register: appliance_status

    - name: Fail if SSA-1 appliance is not operational
      fail:
        msg: "Appliance SSA-1 is not operational"
      when: appliance_status.status != 204

    - name: Get authentication token from the SSA-1 LPAR
      uri:
        url: "{{ ssa1_base_url }}/api-tokens"
        method: POST
        headers:
          Accept: "application/vnd.ibm.zaci.payload+json"
          Content-Type: "application/vnd.ibm.zaci.payload+json;version=1.0"
          zACI-API: "com.ibm.zaci.system/1.0"
        body:
          kind: "request"
          parameters:
            user: "{{ ssa1_admin_user }}"
            password: "{{ ssa1_admin_password }}"
        validate_certs: false
        return_content: true
        body_format: json
      register: auth_response

    - name: Fail if SSA-1 did not response properly
      fail:
        msg: "Appliance SSA-1 authentication failed"
      when: auth_response.status != 200

    - name: Extract the SSA1-admin token
      set_fact:
        ssa1_admin_token: "{{ auth_response.json.parameters.token }}"

    - name: Get Spyre cards associated with SSA-1
      uri:
        url: "{{ ssa1_base_url }}/spyre-cards"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
          Authorization: "Bearer {{ ssa1_admin_token }}"
        validate_certs: no
        return_content: yes
        status_code: 200
      register: spyre_response

    - name: Printing the number of Spyre cards associated with SSA-1
      debug:
        msg: "{{ spyre_response.json.parameters | length }}"

    - name: Get health status of Spyre cards on SSA-1
      uri:
        url: "{{ ssa1_base_url }}/health"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
          Authorization: "Bearer {{ ssa1_admin_token }}"
        validate_certs: no
        return_content: yes
        status_code: 200
      register: health_response

    - name: Gathering health details for SSA-1
      set_fact:
        spyre_details: "{{ health_response.json.parameters.spyre_cards_health_monitor[0].details }}"

    - name: Get the online and offline card lists for SSA-1
      set_fact:
        online_cards: "{{ spyre_details | dict2items | selectattr('value.status', 'equalto', 'OK') | map(attribute='key') | list }}"
        offline_cards: "{{ spyre_details | dict2items | rejectattr('value.status', 'equalto', 'OK') | map(attribute='key') | list }}"

    - name: Display results for SSA-1
      debug:
        msg: 
          - "Online Cards: {{ online_cards }}"
          - "Offline Cards: {{ offline_cards }}"

    - name: Check if SSA-2 appliance is operational
      uri:
        url: "{{ ssa2_base_url }}/appliance/is-operational"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
        validate_certs: no
        status_code: 204
      register: appliance_status

    - name: Fail if SSA-2 appliance is not operational
      fail:
        msg: "Appliance SSA-2 is not operational"
      when: appliance_status.status != 204

    - name: Get authentication token from the SSA-2 LPAR
      uri:
        url: "{{ ssa2_base_url }}/api-tokens"
        method: POST
        headers:
          Accept: "application/vnd.ibm.zaci.payload+json"
          Content-Type: "application/vnd.ibm.zaci.payload+json;version=1.0"
          zACI-API: "com.ibm.zaci.system/1.0"
        body:
          kind: "request"
          parameters:
            user: "{{ ssa2_admin_user }}"
            password: "{{ ssa2_admin_password }}"
        validate_certs: false
        return_content: true
        body_format: json
      register: auth_response

    - name: Fail if SSA-2 did not response properly
      fail:
        msg: "Appliance SSA-2 authentication failed"
      when: auth_response.status != 200

    - name: Extract the SSA2-admin token
      set_fact:
        ssa2_admin_token: "{{ auth_response.json.parameters.token }}"

    - name: Get Spyre cards associated with SSA-2
      uri:
        url: "{{ ssa2_base_url }}/spyre-cards"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
          Authorization: "Bearer {{ ssa2_admin_token }}"
        validate_certs: no
        return_content: yes
        status_code: 200
      register: spyre_response

    - name: Printing the number of Spyre cards associated with SSA-2
      debug:
        msg: "{{ spyre_response.json.parameters | length }}"

    - name: Get health status of Spyre cards on SSA-2
      uri:
        url: "{{ ssa2_base_url }}/health"
        method: GET
        headers:
          zaci-api: "com.ibm.zaci.system/1.0"
          accept: "application/vnd.ibm.zaci.payload+json;version=1.0"
          Authorization: "Bearer {{ ssa2_admin_token }}"
        validate_certs: no
        return_content: yes
        status_code: 200
      register: health_response

    - name: Gathering health details for SSA-2
      set_fact:
        spyre_details: "{{ health_response.json.parameters.spyre_cards_health_monitor[0].details }}"

    - name: Get the online and offline card lists for SSA-2
      set_fact:
        online_cards: "{{ spyre_details | dict2items | selectattr('value.status', 'equalto', 'OK') | map(attribute='key') | list }}"
        offline_cards: "{{ spyre_details | dict2items | rejectattr('value.status', 'equalto', 'OK') | map(attribute='key') | list }}"

    - name: Display results for SSA-2
      debug:
        msg: 
          - "Online Cards: {{ online_cards }}"
          - "Offline Cards: {{ offline_cards }}"