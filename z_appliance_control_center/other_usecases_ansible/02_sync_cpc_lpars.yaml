# *+------------------------------------------------------------------------+
# *| Â© Copyright IBM Corp. 2025                                             |
# *| [10.17.2025]                                                           |
# *|   - Tested with ACC 1.2.6                                              |
# *|   - Initial release                                                    |
# *| [12.12.2025]                                                           |
# *|   - Tested with ACC 1.2.10                                             |
# *|   - Added checking of environment variables                            |
# *|   - Renamed other_usecases_ansible/02_sync_demo to                     |
# *|     other_usecases_ansible/02_sync_cpc_lpars.yaml.                     |
# *+------------------------------------------------------------------------+
- name: ACC playbook, to be run as an ACC-admin, for syncing ACC with the HMC.
  hosts: localhost
  vars_files:
    - admin_vars.yaml

  pre_tasks:
    - name: Prepare ACC URL
      tags: admin
      ansible.builtin.set_fact:
        cc_url: "https://{{ acc_ip }}:{{ acc_port }}/api"

    - name: Printing the ACC url
      tags: admin
      ansible.builtin.debug:
        msg: "{{ cc_url }}"

    - name: Get Initialize status
      ansible.builtin.uri:
        url: "{{ cc_url }}/init"
        method: GET
        return_content: true
        validate_certs: false
      register: get_init_response

    - name: Print init response
      ansible.builtin.debug:
        var: get_init_response.json

    - name: Set ACC mode fact
      ansible.builtin.set_fact:
        acc_mode: "{{ get_init_response.json.mode }}"

    - name: Print detected ACC mode
      ansible.builtin.debug:
        msg: "ACC is running in '{{ acc_mode }}' mode."

    - name: Reminder - Export HMC credentials
      when: acc_mode == "default"
      ansible.builtin.pause:
        prompt: |
          Before running this playbook, please export HMC credentials:

          export HMC_USER=<enter_HMC_username>
          export HMC_PASSWORD=<enter_HMC_password>

          Press Ctrl+C now to cancel if you haven't done this.
          The playbook will continue shortly.
        seconds: 5

    - name: Check required environment variables
      vars:
        required_env_vars:
          - HMC_USER
          - HMC_PASSWORD

      ansible.builtin.fail:
        msg: "Missing required environment variable: {{ item }}"
      when:
        - acc_mode == "default"
        - lookup('env', item) == ""
      loop: "{{ required_env_vars }}"

  vars_prompt:
    - name: cc_admin_user
      prompt: "Enter ACC-admin's username"
      private: false

    - name: cc_admin_password
      prompt: "Enter ACC-admin's password"
      private: true

  tasks:

    - name: 00 - Check MFA is enabled or not
      ansible.legacy.pause:
        prompt: "Do you have MFA enabled? (yes/no)"
        echo: yes
      register: mfa_enabled_input

    - name: 01 - Set MFA enabled
      ansible.legacy.set_fact:
        mfa_enabled: "{{ mfa_enabled_input.user_input | lower == 'yes' }}"

    - name: 02 - Prompt for OTP if MFA is enabled
      when: mfa_enabled
      ansible.legacy.pause:
        prompt: "Enter MFA OTP generated for admin:"
      register: mfa_otp_input

    - name: 03 - Get authentication token from the ACC as admin
      tags: admin
      ansible.builtin.uri:
        url: "{{ cc_url }}/user/token"
        body:
          username: "{{ cc_admin_user }}"
          password: "{{ cc_admin_password }}"
          otp: "{{ (mfa_admin_otp_input.user_input if mfa_enabled else omit) }}"
        body_format: json
        method: POST
        return_content: true
        validate_certs: false
      register: auth_response

    - name: Extract the admin token
      tags: admin
      ansible.builtin.set_fact:
        access_token: "{{ auth_response.json.access_token }}"

    - name: 04 - Set HMC configuration in the ACC
      tags: admin
      when: acc_mode == "default"
      ansible.builtin.uri:
        url: "{{ cc_url }}/config/hmcconfig"
        timeout: 200
        method: POST
        body:
          host: "{{ hmc_url }}"
          userid: "{{ hmc_user }}"
          password: "{{ hmc_password }}"
          verify_cert: false
        body_format: json
        headers:
          Authorization: "Bearer {{ access_token }}"
          Content-Type: application/json
        validate_certs: false
        status_code: 204
      register: response

    - name: 05 - Sync CPCs (only in default mode)
      tags: admin
      when: acc_mode == "default"
      ansible.builtin.uri:
        url: "{{ cc_url }}/sync/cpcs"
        method: POST
        headers:
          Authorization: "Bearer {{ access_token }}"
          accept: "application/json"
        validate_certs: false
      register: cpc_sync_response

    - name: Print CPC sync response
      when: acc_mode == "default"
      ansible.builtin.debug:
        var: cpc_sync_response.json

    - name: 06 - Standalone mode sync reminder
      when: acc_mode == "standalone"
      ansible.builtin.pause:
        prompt: |
          ACC is running in standalone mode.
          IMPORTANT:
          Reminder: Before syncing LPARs, ensure the appliances assigned to the owner are unlocked.
          If the appliance is not unlocked, ACC may not be able to perform a proper LPAR sync
          and may return: "All lpars are up-to-date".
        seconds: 5

    - name: 07 - Sync LPARs
      tags: admin
      ansible.builtin.uri:
        url: "{{ cc_url }}/sync/lpars"
        method: POST
        headers:
          Authorization: "Bearer {{ access_token }}"
        validate_certs: false
      register: lpar_sync_response

    - name: Print LPAR sync response
      ansible.builtin.debug:
        var: lpar_sync_response.json
