---
# tasks file for deprovision_ims
- name: Provision IMS
  collections:
    - ibm.ibm_zos_core
    - ibm.ibm_zos_ims

  block:

    # - include_role:
    #     name: ims_cobol_scan_dir

    # - include_role:
    #     name: ims_cobol_stop_delete_ims_databases

    # - include_role:
    #     name: ims_cobol_remove_old_registered_databases

    - include_role:
        name: install-bzip2

    - include_role:
        name: stop_mpp

    - include_role:
        name: stop_jmp

    - name: Stop all IMS resources
      ims_command:
        batch:
          - command: STOP DC
            plex: '{{ DFS_IMSPlex }}'
            route: '{{ DFS_IMS_SSID }}'
          - command: STOP PGM ALL
            plex: '{{ DFS_IMSPlex }}'
            route: '{{ DFS_IMS_SSID }}'
          - command: STOP TRAN ALL
            plex: '{{ DFS_IMSPlex }}'
            route: '{{ DFS_IMS_SSID }}'
          - command: STOP DB ALL
            plex: '{{ DFS_IMSPlex }}'
            route: '{{ DFS_IMS_SSID }}'
      ignore_errors: yes

    - name: Immediate IMS Shutdown
      ims_command:
        command: CHE FREEZE
        plex: '{{ DFS_IMSPlex }}'
        route: '{{ DFS_IMS_SSID }}'
      ignore_errors: yes

    # Stop ICON
    - block:
      - include_role:
          name: ims_common
        vars:
          icon: stop
          ctl: ""
          wait_for_job: false
          cold_start: false

    # Stop ODBM
    - include_role:
        name: ims_odbm
      vars:
        odbm: stop

    # Stop OM by calling its role
    - block:
      - include_role:
          name: ims_operations_manager
        vars:
          om: stop

    # Stop RM by calling its role
    - block:
      - include_role:
          name: ims_resource_manager
        vars:
          rm: stop

    # Stop SCI by calling its role
    - block:
        - include_role:
            name: ims_structured_call_interface
          vars:
            sci: stop

    - block:
        - include_role:
            name: ims_dataset
          vars:
            work_dataset: ""
            sysdef_datasets: delete
            runtime_datasets: delete
            system_datasets: ""

    - block:
      - include_role:
          name: ims_catalog
        vars:
          catalog: delete

    - block:
      - include_role:
          name: ims_iefjobs
        vars:
          iefjobs: delete

    - block:
      - include_role:
          name: ims_proclib
        vars:
          delete: true