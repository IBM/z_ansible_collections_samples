- name: Provision IMS DB/DC
  hosts: zsystem
  gather_facts: false
  # * Include different variable files depending on environment/inventory used
  vars_files:
    - "{{ vars_folder_name }}/ims-dbdc.yml"
  environment: "{{ system_environment }}"

  vars:
    - provision: true

  tasks:
    - name: Create temporary directory to store provisioning files
      ansible.builtin.tempfile:
        state: directory
      register: provision_tmp_dir
      tags:
        - always

    - vars:
        uss_file_path: "{{ provision_tmp_dir.path }}"
      block:
        - ansible.builtin.include_role:
            name: install-bzip2

        - ansible.builtin.include_role:
            name: ims_dataset
          vars:
            work_dataset: allocate
            sysdef_datasets: allocate
            runtime_datasets: allocate

        - ansible.builtin.include_role:
            name: ims_initialize
          vars:
            DYNAMICALLY_RESERVE_PORTS: false
            send_procs: true
            DFS_INIT_JAVA_CONF: false

        - ansible.builtin.include_role:
            name: ims_proclib
          vars:
            create_sample: true

        - ansible.builtin.include_role:
            name: ims_sysdef
          vars:
            preprocess: true
            stage1: true
            stage2: true

        - ansible.builtin.include_role:
            name: ims_racf
          vars:
            prep_racf: true

        - ansible.builtin.include_role:
            name: ims_apf
          vars:
            auth_datasets: true

        - ansible.builtin.include_role:
            name: ims_dataset
          vars:
            system_datasets: allocate

        - ansible.builtin.include_role:
            name: ims_catalog
          vars:
            catalog: allocate

        - ansible.builtin.include_role:
            name: ims_dbrc
          vars:
            prep_dbrc: true

        - ansible.builtin.include_role:
            name: ims_proclib
          vars:
            add: true
            bpeconfg: true

        # Call SCI config to copy & config SCI
        - ansible.builtin.include_role:
            name: ims_structured_call_interface
          vars:
            sci: config

        # Call OM config to copy & config OM
        - ansible.builtin.include_role:
            name: ims_operations_manager
          vars:
            om: config

        # Call RM config to copy & config RM
        - ansible.builtin.include_role:
            name: ims_resource_manager
          vars:
            rm: config

        # Call CQS to config
        - ansible.builtin.include_role:
            name: ims_common_queue
          vars:
            cqs: config

        - ansible.builtin.include_role:
            name: ims_iefjobs
          vars:
            iefjobs: create

        - ansible.builtin.include_role:
            name: ims_proclib
          vars:
            copy: true
            copy_to_jobs: true
            copy_stage_libs: true

        - ansible.builtin.include_role:
            name: ims_exit
          vars:
            prep_exits: true

        # Run DBD, PSB, and ACB gen
        - ansible.builtin.include_role:
            name: ims_gen
          vars:
            dbd_gen: true
            psb_gen: true
            acb_gen: true

        - ansible.builtin.include_role:
            name: ims_online_change
          vars:
            enable_olc: true
            active_libs: true

        - ansible.builtin.include_role:
            name: ims_dbrc
          vars:
            dbrc_defaults: true

        - ansible.builtin.include_role:
            name: ims_catalog
          vars:
            catalog: "load"

        - ansible.builtin.include_role:
            name: ims_region

        # Start SCI
        - ansible.builtin.include_role:
            name: ims_structured_call_interface
          vars:
            sci: start

        # Start OM
        - ansible.builtin.include_role:
            name: ims_operations_manager
          vars:
            om: start

        # Start RM
        - ansible.builtin.include_role:
            name: ims_resource_manager
          vars:
            rm: start

        - ansible.builtin.include_role:
            name: ims_common
          vars:
            icon: start
            ctl: start
            wait_for_job: true
            cold_start: true

        # Query OM
        - ansible.builtin.include_role:
            name: ims_operations_manager
          vars:
            om: query

        # Query SCI
        - ansible.builtin.include_role:
            name: ims_structured_call_interface
          vars:
            sci: query

        # Query RM
        - ansible.builtin.include_role:
            name: ims_resource_manager
          vars:
            rm: query

      always:
        - name: Delete the temporary provision files directory
          ansible.builtin.file:
            path: "{{ provision_tmp_dir.path }}"
            state: absent
      # tags:
      #  - always
