- name: Provisioning/Deployment of IMS COBOL Application
  hosts: zsystem
  collections:
    - ibm.ibm_zos_core
    - ibm.ibm_zos_ims
  gather_facts: false
  vars_files:
    - "{{ vars_folder_name }}/ims_cobol.yml"
  environment: '{{ system_environment }}'

  tasks:
    - name: IMS COBOL App Provision
      block:

        # Copy and extract the sample COBOL files
        - ansible.builtin.include_role:
            name: ims_cobol_copy_extract_files

        # # Create Application Datasets
        - ansible.builtin.include_role:
            name: ims_cobol_create_app_datasets

        # Execute permissions to copy data and copy it to uss datasets and
        # copy the DBD's and PSB's to the datasets
        - ansible.builtin.include_role:
            name: ims_cobol_execute_permissions_and_copy_ussDatasets

        # DBDGEN, PSBGEN, ACBGEN
        - ansible.builtin.include_role:
            name: ims_cobol_run_gens
          vars:
            dbd_gen: true
            psb_gen: true
            acb_gen: true

        - ansible.builtin.include_role:
            name: ims_cobol_check_acblib

        - ansible.builtin.include_role:
            name: ims_cobol_copy_acblib_to_inactive_acb

        # Compile and link Cobol and load programs
        - ansible.builtin.include_role:
            name: ims_cobol_compile_link_cobol

        # Create dynamic allocation
        - ansible.builtin.include_role:
            name: ims_cobol_create_dynamic_alloc

        # Load data
        - ansible.builtin.include_role:
            name: ims_cobol_load_accounts

        - ansible.builtin.include_role:
            name: ims_cobol_load_customer_accounts

        - ansible.builtin.include_role:
            name: ims_cobol_load_customer_data

        - ansible.builtin.include_role:
            name: ims_cobol_load_history

        - ansible.builtin.include_role:
            name: ims_cobol_load_tsta

        # Register Db to Recons
        - ansible.builtin.include_role:
            name: ims_cobol_register_db_to_recons

        # Create and start IMS databases
        - ansible.builtin.include_role:
            name: ims_cobol_define_ims_databases

        # Create and start IMS application resources - Pgms, Trans
        - ansible.builtin.include_role:
            name: ims_cobol_define_app_resources

        # Define and start the MPP Region
        - ansible.builtin.include_role:
            name: ims_cobol_define_mpp_region
          vars:
            mpp: true
