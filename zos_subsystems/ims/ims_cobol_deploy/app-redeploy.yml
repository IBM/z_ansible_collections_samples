---
- name: IMS Cobol Application Re-deployment
  hosts: zsystem
  collections:
    - ibm.ibm_zos_core
    - ibm.ibm_zos_ims
  gather_facts: false
  vars_files:
    - "{{ vars_folder_name }}/ims_cobol.yml"
  environment: "{{ system_environment }}"

  tasks:
    # Rebuild and update ACBLIB (run all gens) if requested.
    - name: Rebuild and update ACBLIB.
      when: UPDATE_ACB
      block:
        - ansible.builtin.include_role:
            name: ims_cobol_run_gens
          vars:
            dbd_gen: true
            psb_gen: true
            acb_gen: true

        - ansible.builtin.include_role:
            name: ims_cobol_check_acblib

        - ansible.builtin.include_role:
            name: ims_cobol_copy_acblib_to_inactive_acb

    # Compile and link cobol apps
    - ansible.builtin.include_role:
        name: ims_cobol_compile_link_cobol

    # Create dynamic allocation
    - ansible.builtin.include_role:
        name: ims_cobol_create_dynamic_alloc

    # Reload the data if requested
    - name: Reload the data.
      when: UPDATE_DATA
      block:
        - ansible.builtin.include_role:
            name: ims_cobol_stop_ims_databases

        - ansible.builtin.include_role:
            name: ims_cobol_load_accounts

        - ansible.builtin.include_role:
            name: ims_cobol_load_customer_accounts

        - ansible.builtin.include_role:
            name: ims_cobol_load_customer_data

        - ansible.builtin.include_role:
            name: ims_cobol_load_history

        - ansible.builtin.include_role:
            name: ims_cobol_load_tsta

        # Restart IMS databases
        - ansible.builtin.include_role:
            name: ims_cobol_define_ims_databases

    # Refresh IMS application resources
    - ansible.builtin.include_role:
        name: ims_cobol_refresh_ims_resources
