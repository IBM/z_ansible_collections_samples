# =================================================================
# Licensed Materials - Property of IBM
#
# (c) Copyright IBM Corp. 2023 All Rights Reserved
#
# US Government Users Restricted Rights - Use, duplication or
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
# =================================================================

# Required Python packages:
#
# ansible
# openstackclient
# openstacksdk
# netaddr

- hosts: localhost
  gather_facts: false
  tasks:
    - name: 'Import common yaml'
      ansible.builtin.include_tasks: "{{ playbook_dir }}/common.yaml"

    - name: 'Get image name for kvm'
      ansible.builtin.set_fact:
        image_name: icic_rhcos_{{ vm_type }}_{{ disk_type }}_{{ openshift_version }}_{{ openshift_minor_version }}
      when:
        - vm_type == "kvm"

    - name: 'Get image name for ZVM'
      ansible.builtin.set_fact:
        image_name: "icic_rhcos_{{ vm_type }}_{{ disk_type }}_{{ openshift_version }}_{{ openshift_minor_version }}"
      when:
        - vm_type == "zvm"

    - name: 'Export infra ID'
      ansible.builtin.shell:
        cmd: "jq -r .infraID metadata.json"
      register: infra_id

    - name: 'Set new worker properties'
      ansible.builtin.set_fact:
        add_worker_number: "{{ worker_number | default(1) }}"
        add_worker_ip: "{{ ip | default('random') }}"
        new_worker_file: "/tmp/{{ infra_id.stdout }}-new-worker"

    - name: Check if worker count is matched the ip address
      ansible.builtin.fail:
        msg: "worker ip does not match the worker number"
      failed_when:
        - add_worker_ip != "random"
        - "{{ add_worker_ip.split(',') | length }} != {{ add_worker_number | int }}"

    - name: Find existing compute nodes
      openstack.cloud.server_info:
        name: '{{ infra_id.stdout }}-worker-*'
        timeout: "{{ create_server_timeout|int * 60 }}"
        filters:
          vm_state: active
      register: existing_compute

    - name: Create lists
      ansible.builtin.set_fact:
        worker_sequence: "{{ range(count_of_ex_cmpt|int, count_of_ex_cmpt|int + add_worker_number|int) | list }}"
        add_worker_ips: "{{add_worker_ip.split(',')}}"
      vars:
        count_of_ex_cmpt: "{{ existing_compute.servers|count }}"

    - name: Remove existing worker file
      ansible.builtin.file:
        path: "{{ new_worker_file }}"
        state: absent

    - name: Generate new worker name
      ansible.builtin.lineinfile:
        path: "{{ new_worker_file }}"
        create: true
        insertafter: EOF
        line: "{{ name_list_ip if add_worker_ip != 'random' else name_list_random }}"
      vars:
        name_list_ip: "{% set zipped_lists = worker_sequence | zip(add_worker_ips|list) %}{% for item in zipped_lists|list %}{{ item.0 }} {{ item.1 }}\n{% endfor %}"
        name_list_random: "{% for item in worker_sequence %}{{ item }} random\n{% endfor %}"

    - name: 'Get new worker list'
      ansible.builtin.command:
        cmd: cat {{ new_worker_file }}
      register: new_worker_list

    - name: 'Generate worker node json file'
      ansible.builtin.script: tools/generate-new-worker-ignition.sh "{{ os_compute_server_name }}-{{ item.split(' ')[0] }}"
      with_items: "{{ new_worker_list.stdout_lines }}"

    - name: 'Create the compute server ports'
      openstack.cloud.port:
        name: "{{ os_port_worker }}-{{ item.split(' ')[0] }}"
        network: "{{ use_network_name }}"
        security_groups:
          - "{{ os_sg_worker }}"
        fixed_ips:
          - subnet: "{{ use_network_subnet }}"
            ip_address: "{{ item.split(' ')[1] }}"
      register: ports
      with_items: "{{ new_worker_list.stdout_lines }}"
      when: add_worker_ip != "random"

    - name: 'Create the compute server ports'
      openstack.cloud.port:
        name: "{{ os_port_worker }}-{{ item.split(' ')[0] }}"
        network: "{{ use_network_name }}"
        security_groups:
          - "{{ os_sg_worker }}"
      register: ports
      with_items: "{{ new_worker_list.stdout_lines }}"
      when: add_worker_ip == "random"

    - name: 'Set compute server ports tag'
      ansible.builtin.command:
        cmd: "openstack port set --tag {{ cluster_id_tag }} {{ os_port_worker }}-{{ item.split(' ')[0] }}"
      with_items: "{{ new_worker_list.stdout_lines }}"

    - name: 'Create the compute servers'
      openstack.cloud.server:
        name: "{{ os_compute_server_name }}-{{ item.split(' ')[0] }}"
        image: "{{ image_name }}"
        flavor: "{{ os_flavor_worker }}"
        auto_ip: false
        timeout: "{{ create_server_timeout|int * 60 }}"
        userdata: "{{ lookup('file', [ os_compute_server_name, item.split(' ')[0] , 'ignition.json'] | join('-'))  | string }}"
        availability_zone: "{{ create_server_zone }}"
        nics:
          - port-name: "{{ os_port_worker }}-{{ item.split(' ')[0] }}"
        meta: "{{ cluster_id_tag }}"
      with_items: "{{ new_worker_list.stdout_lines }}"
      when:
        - vm_type == "kvm"
        - volume_type_id is not defined

    - name: 'Create the compute servers'
      openstack.cloud.server:
        name: "{{ os_compute_server_name }}-{{ item.split(' ')[0] }}"
        image: "{{ image_name }}"
        flavor: "{{ os_flavor_worker }}"
        auto_ip: false
        timeout: "{{ create_server_timeout|int * 60 }}"
        userdata: "{{ lookup('file', [ os_compute_server_name, item.split(' ')[0], 'ignition.json'] | join('-'))  | string }}"
        availability_zone: "{{ create_server_zone }}"
        nics:
          - port-name: "{{ os_port_worker }}-{{ item.split(' ')[0] }}"
        meta: "{{ cluster_id_tag }},custom_dns={{ os_dns_domain }}"
      with_items: "{{ new_worker_list.stdout_lines }}"
      when:
        - disk_type == "dasd"
        - vm_type == "zvm"
        - volume_type_id is not defined

    - name: 'Convert compute server flavor from value into number'
      ansible.builtin.command:
        cmd: "openstack flavor show {{ os_flavor_worker }} -c disk -f value"
      register: compute_flavor_size
      when:
        - disk_type == "scsi"

    - name: 'Create the compute servers with default boot volume'
      openstack.cloud.server:
        name: "{{ os_compute_server_name }}-{{ item.split(' ')[0] }}"
        image: "{{ image_name }}"
        flavor: "{{ os_flavor_worker }}"
        auto_ip: false
        timeout: "{{ create_server_timeout|int * 60 }}"
        userdata: "{{ lookup('file', [ os_compute_server_name, item.split(' ')[0] , 'ignition.json'] | join('-'))  | string }}"
        availability_zone: "{{ create_server_zone }}"
        nics:
          - port-name: "{{ os_port_worker }}-{{ item.split(' ')[0] }}"
        boot_from_volume: true
        volume_size: "{{ compute_flavor_size.stdout_lines[0]}}"
        terminate_volume: true
        meta: "{{ cluster_id_tag }},custom_dns={{ os_dns_domain }}"
      with_items: "{{ new_worker_list.stdout_lines }}"
      when:
        - disk_type == "scsi"
        - vm_type == "zvm"
        - volume_type_id is not defined

    - name: 'Create compute boot volume'
      openstack.cloud.volume:
        state: present
        name: "{{ item }}-boot"
        image: "{{ image_name }}"
        size: "{{ compute_flavor_size.stdout_lines[0]}}"
        volume_type: "{{ volume_type_id }}"
        metadata: "{{ cluster_id_tag }}"
        timeout: "{{ create_server_timeout|int * 60 }}"
      with_items: "{{ new_worker_list.stdout_lines }}"
      when:
        - disk_type == "scsi"
        - volume_type_id is defined

    - name: 'Set compute volume bootable'
      ansible.builtin.shell: openstack --os-volume-api-version=3 volume set --bootable "{{ item }}-boot"
      with_items: "{{ new_worker_list.stdout_lines }}"
      when:
        - disk_type == "scsi"
        - volume_type_id is defined

    - name: 'Create the compute server with boot volume'
      openstack.cloud.server:
        name: "{{ os_compute_server_name }}-{{ item.split(' ')[0] }}"
        flavor: "{{ os_flavor_worker }}"
        boot_volume: "{{ item }}-boot"
        auto_ip: false
        availability_zone: "{{ create_server_zone }}"
        timeout: "{{ create_server_timeout|int * 60 }}"
        userdata: "{{ lookup('file', [ os_compute_server_name, item.split(' ')[0] , 'ignition.json'] | join('-'))  | string }}"
        nics:
          - port-name: "{{ os_port_worker }}-{{ item.split(' ')[0] }}"
        meta: "{{ cluster_id_tag }},custom_dns={{ os_dns_domain }}"
        terminate_volume: true
      with_items: "{{ new_worker_list.stdout_lines }}"
      when:
        - disk_type == "scsi"
        - volume_type_id is defined

    - name: 'Waiting for approve worker CSR'
      ansible.builtin.include_tasks: approve_worker.yaml
      vars:
        workerid: "{{ os_compute_server_name }}-{{ item.split(' ')[0] }}"
      register: worker_csr_sleeper
      with_items: "{{ new_worker_list.stdout_lines }}"

- import_playbook: configure-bastion-properties.yaml

- hosts: localhost
  tasks:
    - name: 'Get new worker name list'
      command: /usr/bin/python3
      args:
        stdin: |
          import yaml
          with open("cluster-template.yaml", "r") as stream:
              cluster = yaml.safe_load(stream)
          workers = cluster["cluster_nodes"]["infra"]
          print(workers)
      register: works_list_results

    - set_fact:
        workers_list: "{{ item.split(',') }}"
      with_items: "{{ works_list_results.stdout_lines }}"
  
- hosts: bastion
  tasks:
    - name: Modify dns & haproxy on bastion
      include_tasks: modify-bastion.yaml
      vars:
        worker_name: "{{ item.split(':')[0] }}"
        worker_ip: "{{ item.split(':')[-1] }}"
        cluster_domain_name: "{{ hostvars['localhost']['cluster_name'] }}.{{ hostvars['localhost']['base_domain'] }}"
      with_items: "{{ hostvars['localhost']['workers_list'] }}" 
      when:
        - use_internal_bastion == true

