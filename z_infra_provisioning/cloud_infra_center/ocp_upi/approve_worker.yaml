# =================================================================
# Licensed Materials - Property of IBM
#
# (c) Copyright IBM Corp. 2021 All Rights Reserved
#
# US Government Users Restricted Rights - Use, duplication or
# disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
# =================================================================

- name: Approving the worker CSR
  block:
    - name: Approve CSR in loop
      environment:
        KUBECONFIG: "./auth/kubeconfig"
      ansible.builtin.shell: |
        ./oc get csr -o name | xargs ./oc adm certificate approve &> /dev/null
        echo $(./oc get nodes -o custom-columns=NAME:.metadata.name)
      register: result
      until: result.stdout.find(workerid) != -1
      retries: 30
      delay: 10
  rescue:
    - name: Approve CSR failed
      ansible.builtin.debug:
        msg: 'Please approve all pending CSR manually via: oc get csr -o name | xargs oc adm certificate approve'

- name: Update Compute node label
  block:
    - name: Apply Compute node label
      environment:
        KUBECONFIG: "./auth/kubeconfig"
      ansible.builtin.shell: |
        ./kubectl label node {{workerid}} node-role.kubernetes.io/{{comp_name_suffix | default('worker')}}=true --kubeconfig auth/kubeconfig &> /dev/null
        echo $(./oc get nodes -o custom-columns=NAME:.metadata.name)
      register: result
      until: result.stdout.find(workerid) != -1
      retries: 30
      delay: 10
      when: comp_name_suffix | default('worker') != 'worker'
  rescue:
    - name: Update Compute node label manually
      ansible.builtin.debug:
        msg: "Please update compute node label manually via: ./kubectl label node <node name> node-role.kubernetes.io/{{comp_name_suffix | default('worker')}}=true --kubeconfig auth/kubeconfig"
      when: comp_name_suffix | default('worker') != 'worker'

- name: Update the compute node taint to NoSchedule
  block:
    - name: Apply NoSchedule taint
      environment:
        KUBECONFIG: "./auth/kubeconfig"
      ansible.builtin.shell: |
        ./kubectl taint node {{workerid}} node-role.kubernetes.io/{{comp_name_suffix | default('worker')}}=true  node-role.kubernetes.io/worker- --kubeconfig auth/kubeconfig &> /dev/null
        echo $(./oc get nodes -o custom-columns=NAME:.metadata.name)
      register: result
      until: result.stdout.find(workerid) != -1
      retries: 30
      delay: 10
      when: comp_name_suffix | default('worker') != 'worker'
  rescue:
    - name: Apply NoSchedule taint manually
      ansible.builtin.debug:
        msg: "Please update compute node label manually via: ./kubectl taint node <node name> node-role.kubernetes.io/{{comp_name_suffix | default('worker')}}='':NoSchedule --kubeconfig auth/kubeconfig"
      when: comp_name_suffix | default('worker') != 'worker'