###############################################################################
# Â© Copyright IBM Corporation 2020, 2021
###############################################################################

- hosts: all
  collections:
    - ibm.ibm_zos_core
  gather_facts: false
  environment: "{{ environment_vars }}"
  vars:
    # cert_label: 'ANDY SITE' # must be 8 char or less
    # cert_type: 'SITE'  # USER or SITE or CERTAUTH
    # sign_with: 'CERTAUTH' # blank or CERTAUTH
    # sign_label: 'ANDY CA'
    # owner_id: 'OMVSKERN'
    # keyring_name: 'SharedRing1'

    cert_label: 'TIV3 Cert' # must be 8 char or less
    cert_type: 'SITE'  # USER or SITE or CERTAUTH
    sign_with: 'CERTAUTH' # blank or CERTAUTH
    sign_label: 'IBM CA'
    owner_id: 'OMVSADM'
    keyring_name: 'WEBSSL'

    cert_found: false
    today: ''

  tasks:
    - name: Create temporary directory to store bank files
      ansible.builtin.tempfile:
        state: directory
      register: playbook_tmp_dir

    - block:
        - name: Run Health Checker
          ansible.builtin.include_role:
            name: issue_operator_cmd
          vars:
            task_description: 'Run Health Checker'
            command: "F HZSPROC,RUN,CHECK=(IBMRACF,RACF_CERTIFICATE_EXPIRATION)"

        - name: Run HZSPRINT utility to print Health Checker output
          ansible.builtin.include_role:
            name: print_hc_buffer
          vars:
            hc_check: 'IBMRACF,RACF_CERTIFICATE_EXPIRATION'

        - name: Search for {{ cert_label }} in report
          ansible.builtin.set_fact:
            cert_found: true
          with_items: "{{hc_job_output.jobs.0.ddnames}}"
          when: item.content is search(cert_label)

        - name: Print expiration message
          ansible.builtin.debug:
            msg: "{{ cert_label }} expiring - {{ cert_found }}"

        - name: Get current date
          ansible.builtin.command: "date '+%b%d%y'"
          register: date_result
          when: cert_found
          changed_when: false

        - name: Set date
          ansible.builtin.set_fact:
            today: "{{ date_result.stdout }}"
          when: cert_found

      always:
        - name: Delete the temporary directory
          ansible.builtin.file:
            path: "{{ playbook_tmp_dir.path }}"
            state: absent
      vars:
        uss_file_path: '{{ playbook_tmp_dir.path }}'
