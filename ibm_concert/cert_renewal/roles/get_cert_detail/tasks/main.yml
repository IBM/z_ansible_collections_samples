---
###############################################################################
# Â© Copyright IBM Corporation 2024
###############################################################################

# tasks file for get_cert_detail

##########################################################################
# Get Certificate Detail
##########################################################################

- name: "{{ task_description }}"
  ibm.ibm_zos_core.zos_tso_command:
    commands: "{{tso_command}}"
  register: tso_cmd_output


- ansible.builtin.set_fact:
    buffer: "{{tso_cmd_output.output[0].content}}"
    subject_string: "Subject's Name:"

- ansible.builtin.debug:
    var: buffer

- ansible.builtin.set_fact:
    sn_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'Serial Number') }}"
    sb_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', subject_string) }}"
    cn_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'CN=') }}"
    is_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'Issuer') }}"
    ka_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'Signing Algorithm') }}"
    ks_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'Key Size') }}"
    vf_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'Start Date') }}"
    vt_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'End Date') }}"
    tp_index: "{{ lookup('ansible.utils.index_of', buffer, 'regex', 'Fingerprint') }}"

- name: Build cert details for {{role_cert.cert_label}}
  ansible.builtin.set_fact:
    cert_detail: "{{ cert_detail | default({}) | combine ({
      'Serial Number': buffer[sn_index | int + 1],
      'Name': role_cert.cert_label,
      'Subject': '',
      'CN': buffer[sb_index | int + 1],
      'Issuer': buffer[is_index | int + 1],
      'Key Algorithm': buffer[ka_index | int][21:],
      'Key Size': buffer[ks_index | int][12:],
      'SANS': '',
      'ValidFrom': buffer[vf_index | int][14:],
      'ValidTo': buffer[vt_index | int][14:],
      'Thumbprint': buffer[tp_index | int + 1],
      'Certificate Hosts': '',
      'System Reference id': '',
      'DN': '',
      'ParentDN': '',
      'Certificate Type': role_cert.cert_type,
      'CreatedOn': '',
      'Primary Owner': role_cert.owner_id,
      'Secondary Owner': '',
      'Namespace': ''
      }) }}"

- name: Add cert into list
  ansible.builtin.set_fact:
    cert_list: '{{ cert_list | default([]) + [cert_detail] }}'
